model Conversation {
  id        BigInt   @id @default(autoincrement())
  matchId   BigInt?  @unique
  userAId   BigInt
  userBId   BigInt
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  match     Match? @relation(fields: [matchId], references: [id])
  userA     User  @relation("ConvUserA", fields: [userAId], references: [id])
  userB     User  @relation("ConvUserB", fields: [userBId], references: [id])
  messages  Message[]
  userStates ConversationUserState[]
  @@index([updatedAt])
  @@index([userAId, updatedAt])
  @@index([userBId, updatedAt])
  @@unique([userAId, userBId])
}

model Message {
  id             BigInt   @id @default(autoincrement())
  conversationId BigInt
  senderId       BigInt
  body           String   @db.Text
  isSystem       Boolean  @default(false)
  followRequestId BigInt?
  createdAt      DateTime @default(now())
  deletedAt      DateTime?
  conversation   Conversation @relation(fields: [conversationId], references: [id])
  sender         User         @relation("MessageSender", fields: [senderId], references: [id])
  followRequest  ProfileAccess? @relation("FollowRequestMessages", fields: [followRequestId], references: [id])
  receipts       MessageReceipt[]
  @@index([conversationId, createdAt])
  @@index([senderId, createdAt])
  @@index([followRequestId])
}

model MessageReceipt {
  id        BigInt   @id @default(autoincrement())
  messageId BigInt
  userId    BigInt
  readAt    DateTime?
  message   Message @relation(fields: [messageId], references: [id])
  user      User    @relation(fields: [userId], references: [id])
  @@unique([messageId, userId])
  @@index([userId, readAt])
}

model ConversationUserState {
  id             BigInt   @id @default(autoincrement())
  conversationId BigInt
  userId         BigInt
  deletedAt      DateTime?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  conversation Conversation @relation(fields: [conversationId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@unique([conversationId, userId])
  @@index([userId, deletedAt])
}
