model User {
  id           BigInt   @id @default(autoincrement())
  email        String   @unique
  passwordHash String
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  deletedAt    DateTime?

  profile      Profile?
  posts        Post[]
  targetProfilePosts Post[] @relation("PostTargetProfile")
  comments     Comment[]
  commentLikes CommentLike[]
  commentMentions CommentMention[] @relation("MentionedUser")
  media        Media[]
  mediaOwned   Media[] @relation("MediaOwner")

  LikesMade   Like[]  @relation("LikesMade")
  LikesGot    Like[]  @relation("LikesGot")

  matchesA     Match[]  @relation("MatchUserA")
  matchesB     Match[]  @relation("MatchUserB")

  conversationsA Conversation[] @relation("ConvUserA")
  conversationsB Conversation[] @relation("ConvUserB")

  messages     Message[] @relation("MessageSender")
  receipts     MessageReceipt[]
  conversationStates ConversationUserState[]

  LikedPosts   LikedPost[]

  blocksMade   UserBlock[] @relation("BlocksMade")
  blocksGot    UserBlock[] @relation("BlocksGot")

  reportsMade  UserReport[] @relation("ReportsMade")
  reportsGot   UserReport[] @relation("ReportsGot")

  quizResults  QuizResult[]

  interests   UserInterest[]
  interestDeltas UserInterestDelta[]
  matchScores MatchScore[] @relation("MatchScoreUser")
  matchScoresAsCandidate MatchScore[] @relation("MatchScoreCandidate")
  compatibilityGiven UserCompatibility[] @relation("CompatibilityViewer")
  compatibilityReceived UserCompatibility[] @relation("CompatibilityTarget")
  feedSeen FeedSeen[]
  preference  UserPreference?
  affinityProfile UserAffinityProfile?

  profileAccessGranted  ProfileAccess[] @relation("ProfileAccessOwner")
  profileAccessReceived ProfileAccess[] @relation("ProfileAccessViewer")
  presortedFeedSegments PresortedFeedSegment[]
  traits                UserTrait[]
  
  // Search index relations
  profileSearchIndex    ProfileSearchIndex?
  interestUserSets      InterestUserSet[]
  interestSubjectUserSets InterestSubjectUserSet[]
  searchableUser        SearchableUser?

  @@index([createdAt])
  @@index([deletedAt])
}

model Profile {
  id            BigInt @id @default(autoincrement())
  userId        BigInt @unique
  user          User   @relation(fields: [userId], references: [id])
  avatarMediaId BigInt?
  heroMediaId   BigInt?
  avatarMedia   Media? @relation("ProfileAvatar", fields: [avatarMediaId], references: [id])
  heroMedia     Media? @relation("ProfileHero", fields: [heroMediaId], references: [id])
  displayName   String?
  bio           String?  @db.Text
  birthdate     DateTime?
  locationText  String?
  lat           Decimal? @db.Decimal(9,6)
  lng           Decimal? @db.Decimal(9,6)
  gender        Gender        @default(UNSPECIFIED)
  intent        DatingIntent  @default(UNSPECIFIED)
  isVisible     Boolean @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  deletedAt     DateTime?
  ratingsGiven  ProfileRating[] @relation("RatingsGiven")
  ratingsGot    ProfileRating[] @relation("RatingsGot")
  stats         ProfileStats?
  top5Lists     Top5List[]
  @@index([isVisible, intent, locationText])
  @@index([avatarMediaId])
  @@index([heroMediaId])
  @@index([lat, lng])
  @@index([deletedAt])
}

model UserTrait {
  id        BigInt   @id @default(autoincrement())
  userId    BigInt
  traitKey  String   // e.g., "personality.funny", "values.adventure"
  value     Decimal  @db.Decimal(10,2)  // Aggregated trait value (mean from quiz answers)
  n         Int      @default(1) // Contribution count (number of quiz answers that contributed to this trait)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User @relation(fields: [userId], references: [id])
  @@unique([userId, traitKey])
  @@index([userId])
  @@index([traitKey])
}
