model JobRun {
  id                  BigInt       @id @default(autoincrement())
  jobName             String
  status              JobRunStatus @default(QUEUED)
  trigger             JobTrigger
  scope               String?
  algorithmVersion    String?
  attempt             Int          @default(1)
  queuedAt            DateTime     @default(now())
  startedAt           DateTime?
  finishedAt          DateTime?
  durationMs          Int?
  queueDelayMs        Int?
  error               String?      @db.Text
  metadata            Json?
  triggeredBy         BigInt?
  cancelRequestedAt   DateTime?
  cancelRequestedBy   BigInt?
  lastHeartbeatAt     DateTime?
  
  // Progress tracking
  currentStage        String?      @db.VarChar(100)
  progressCurrent     Int?
  progressTotal       Int?
  progressPercent     Int?
  progressMessage     String?      @db.VarChar(500)
  
  // Outcome summary
  entitiesProcessed   Int?
  entitiesTotal       Int?
  outcomeSummary      Json?        // { updates: 100, deletes: 5, errors: 2, warnings: 3, ... }
  
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  
  // Schedule relationship (optional)
  scheduleId          String?      @db.VarChar(50)
  schedule            JobSchedule? @relation("ScheduledJobs", fields: [scheduleId], references: [id], onDelete: SetNull)
  
  logs                JobLog[]

  @@index([jobName, status])
  @@index([jobName, queuedAt])
  @@index([status, queuedAt])
  @@index([triggeredBy])
  @@index([status, lastHeartbeatAt])
  @@index([scheduleId])
}

model JobLog {
  id          BigInt   @id @default(autoincrement())
  jobRunId    BigInt
  level       String   @db.VarChar(20)  // debug, info, milestone, warning, error
  stage       String?  @db.VarChar(100)
  message     String   @db.Text
  context     Json?    // Additional structured data
  timestamp   DateTime @default(now())
  
  jobRun      JobRun   @relation(fields: [jobRunId], references: [id], onDelete: Cascade)
  
  @@index([jobRunId, timestamp])
  @@index([level])
}

model WorkerInstance {
  id              String    @id @default(uuid()) @db.VarChar(36)
  workerType      String    @default("job_worker") @db.VarChar(50)
  status          String    @default("STARTING") @db.VarChar(20) // STARTING, RUNNING, STOPPING, STOPPED
  hostname        String?   @db.VarChar(255)
  pid             Int?
  startedAt       DateTime  @default(now())
  lastHeartbeatAt DateTime  @default(now())
  stoppedAt       DateTime?
  jobsProcessed   Int       @default(0)
  metadata        Json?

  @@index([workerType, status])
  @@index([lastHeartbeatAt])
  @@map("WorkerInstance")
}
