# Managing the Feed

This guide explains how to modify the feed configuration, publish changes, and troubleshoot issues.

## Overview

The feed is generated by a **Presort Job** (`feed-presort`) that runs periodically. This job:
1.  Fetches candidates (posts, suggestions, questions).
2.  Scores and ranks them based on weights.
3.  Applies the **Sequence Configuration** (e.g., Video -> Mosaic -> Suggestion).
4.  Caches the result ("segments") for quick retrieval by the frontend.

## 1. Modifying the Feed Configuration

The feed logic is controlled by `backend/src/registry/domains/feed/config.ts`.

### Changing the Sequence
Edit the `sequence` array to change the order or type of cards shown.

```typescript
const sequence: FeedSlot[] = [
  { kind: 'post', mediaType: 'video', count: 2, presentation: 'single' },
  { kind: 'post', mediaType: 'mixed', count: 1, presentation: 'mosaic' }, // Example: Added mosaic
  // ...
];
```

### Changing Scoring Weights
Adjust `scoring.weights` to favor recency, affinity, quality, etc.

## 2. Publishing Changes (CRITICAL)

The Presort Job uses an **Input Hash** to check if it needs to re-run. If the inputs (like user likes, match scores) haven't changed, it skips work to save resources.

**When you modify `config.ts`, you MUST update the version to invalidate the cache.**

1.  Open `backend/src/registry/domains/feed/config.ts`.
2.  Find `FEED_CONFIG_VERSION` at the bottom of the file.
3.  Bump the version string (e.g., `'v2'` -> `'v3'`).

```typescript
// Bump this version whenever you modify the sequence or weights
export const FEED_CONFIG_VERSION = 'v3';
```

If you do not do this, the job will think nothing has changed and will **NOT** regenerate the feed with your new settings.

## 3. Running the Job

After updating the config and version, run the presort job to regenerate the feed.

### For a specific user (Testing)
Use this to verifying changes quickly for your own account.
```bash
npx tsx backend/scripts/jobs/core/feedPresort.ts --userId=<YOUR_USER_ID>
```

### For all users (Production)
```bash
npx tsx backend/scripts/jobs/core/feedPresort.ts --batchSize=100
```

## 4. Verification

1.  Reload the frontend Feed page.
2.  You should see the new layout (e.g., mosaic cards) appear according to your new sequence.
3.  If you don't see changes:
    *   Did you bump `FEED_CONFIG_VERSION`?
    *   Did the job command output `segmentsGenerated: X` (where X > 0)?
    *   If `segmentsGenerated` is 0, check if the job reported "skipped" or "fresh".

## Troubleshooting

**"I changed the config but the feed looks the same."**
*   **Cause**: The job cache didn't invalidate.
*   **Fix**: Update `FEED_CONFIG_VERSION` in `config.ts` and re-run the job.

**"The job runs but generates 0 segments."**
*   **Cause**: No candidates found or strict filtering.
*   **Fix**: Check `feedConfig.caps` or ensure there is content in the database (Posts, Suggestions).

**"My Mosaic/Image slots are missing from the feed."**
*   **Cause**: The system skips slots if no matching content is found.
*   **Verification**: Ensure users have posts with images or mixed media. If a user only has Videos, the 'image' and 'mosaic' slots will be skipped.

